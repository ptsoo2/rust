#[allow(unused_imports)]
use std::io::ErrorKind::WouldBlock;
use std::net::{TcpListener, TcpStream};
use std::sync::atomic::AtomicBool;
use std::sync::atomic::Ordering::{Acquire, Release};
use std::sync::Arc;

use ex_common::bench::bench_multiple;
use ex_common::log;

use ex_database::redis_entry;
use ex_database::redis_value::RedisValue;
use ex_rabbitmq::context::MQContext;
use ex_util::thread_job_queue::ThreadJobQueue;
use lapin::ExchangeKind;
use redis::{Cmd, ConnectionLike, Pipeline, Value};
use std::thread::{self};

use crate::app;

pub fn _test_closure_and_lambda() {
    let mut vec: Vec<i32> = Vec::new();
    vec.push(1);
    vec.push(1);

    log!("{:?}", vec.as_ptr());

    fn lambda_as_ref(vec: &Vec<i32>) {
        log!("{:?}", vec.as_ptr());
    }

    fn lambda_as_move(vec: Vec<i32>) {
        log!("{:?}", vec.as_ptr());
    }

    lambda_as_ref(&vec);
    // lambda_as_move(vec);

    let closure_as_ref = |vec: &Vec<i32>| {
        log!("{:?}", vec.as_ptr());
    };

    let _closure_as_move = |vec: Vec<i32>| {
        log!("{:?}", vec.as_ptr());
    };

    closure_as_ref(&vec);
    // closure_as_move(vec);

    let vec2: Vec<i32> = Vec::new();

    let closure_as_all_ref_capture = || {
        log!("{:?}", vec.as_ptr());
        log!("{:?}", vec2.as_ptr());
    };
    closure_as_all_ref_capture();

    let closure_as_all_move_capture = move || {
        log!("{:?}", vec.as_ptr());
        log!("{:?}", vec2.as_ptr());
    };
    closure_as_all_move_capture();
}

// attempt to add with overflow
pub fn _test_lambda_performance() {
    fn lambda() {
        let mut sum: u32 = 0;
        for idx in 0..10000000 {
            if u32::MAX - sum >= idx {
                sum = 0
            }
            sum += idx;
        }
    }

    lambda();
}

pub fn _test_closure_performance() {
    let closure = || {
        let mut sum: u32 = 0;
        for idx in 0..10000000 {
            if u32::MAX - sum >= idx {
                sum = 0
            }
            sum += idx;
        }
    };

    closure();
}

fn _handle_connection(stream: TcpStream) {
    log!("{:?}", stream);
}

pub fn _test_acceptor() {
    let stop_handle = Arc::new(AtomicBool::new(false));
    let stop_handle_clone = stop_handle.clone();

    ctrlc::set_handler(move || {
        log!("Signal detected!!!!!(request stop)");
        stop_handle_clone.store(true, Release);
    })
    .expect("Error setting Ctrl-C handler");

    let listener = TcpListener::bind("localhost:7878").unwrap();
    while listener.set_nonblocking(true).is_err() {}

    log!("Waiting for Ctrl-C...");
    for stream in listener.incoming() {
        match stream {
            Ok(stream) => _handle_connection(stream),
            Err(err) => {
                if err.kind() != WouldBlock {
                    log!("leaving loop. error: {}", err);
                    break;
                }
            }
        }

        if stop_handle.load(Acquire) {
            log!("stop!!");
            break;
        }
    }

    log!("Exit!!!");
}

// #[allow(unused)]
// pub fn test_mq_long_body() -> anyhow::Result<()> {
//     let conn_tune = ConnectionTuning::default();

//     let mut conn = Connection::insecure_open_tuned("amqp://admin:admin@localhost:5672", conn_tune)?;
//     let channel = conn.open_channel(Some(1))?;

//     let exchange = channel.exchange_declare(
//         amiquip::ExchangeType::Direct,
//         "rust.direct",
//         amiquip::ExchangeDeclareOptions {
//             durable: false,
//             auto_delete: false,
//             internal: false,
//             arguments: amiquip::FieldTable::new(),
//         },
//     )?;

//     bench_multiple("test", 100000, || {
//         exchange.publish(amiquip::Publish::new(b"hel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel1239072309712309712hel12390hel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there7230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there39071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel1239072309712309712hel12390hel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there7230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there39071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there", "hello"));
//     });
//     Ok(())
// }

// #[allow(unused)]
// pub(crate) fn test_mq_no_context() -> anyhow::Result<()> {
//     let conn_tune = ConnectionTuning::default();

//     let mut conn = Connection::insecure_open_tuned("amqp://admin:admin@localhost:5672", conn_tune)?;
//     let channel = conn.open_channel(Some(1))?;

//     let exchange = channel.exchange_declare(
//         amiquip::ExchangeType::Direct,
//         "rust.direct",
//         amiquip::ExchangeDeclareOptions {
//             durable: false,
//             auto_delete: false,
//             internal: false,
//             arguments: amiquip::FieldTable::new(),
//         },
//     )?;

//     bench_multiple("test", 10000, || {
//         let _ = exchange.publish(amiquip::Publish::new(
//             b"hel123907230971230971239071290319027390127097lo ",
//             "hello",
//         ));
//     });
//     Ok(())
// }

#[allow(unused)]
pub async fn test_mq_publish() -> anyhow::Result<()> {
    let conf = app::get_instance().get_config();

    let mut context = MQContext::new(&conf.mq_conf).await?;
    context
        .channel()
        .await?
        .declare_exchange(1, "game_server.direct", ExchangeKind::Direct)
        .await?;

    bench_multiple("name", 10000, || {
        let _ = context.publish(1, "game_server.direct", "12312312", "12312312132");
    });

    context.close().await?;

    Ok(())
}

#[allow(unused)]
fn test_redis() -> anyhow::Result<()> {
    let connection_info = redis_entry::make_connection_info("localhost", 6379, 1, None, None);

    let pool_config = redis_entry::StubConfig::default();
    let pool = redis_entry::make_pool_default(connection_info, pool_config, None)?;

    let mut conn = pool.get()?;
    {
        let rpy = conn.req_command(Cmd::new().arg("PING"))?;
        if let Value::Status(stat) = rpy {
            println!("{}", stat);
        }
    }
    {
        let a = 1;
    }
    {
        // 와.. 너무 쓰레기같이 써야하네..
        let result: Vec<Value> = Pipeline::with_capacity(3)
            .set("132123", "!@3123")
            .get("132123")
            .zrevrange("test_ranking", 0, -1)
            .query(&mut conn)?;

        let result = result.get(3).unwrap();
        if let Value::Bulk(result) = result {
            println!("{:?}", result);
        }
    }
    Ok(())
}

#[allow(unused)]
fn singleton_test() -> anyhow::Result<()> {
    app::get_instance().init()?;

    // singleton test
    let join_handle = thread::spawn(|| -> anyhow::Result<()> {
        let mut conn = app::get_instance().get_redis_pool(0).unwrap().get()?;

        let rpy = conn.req_command(redis::Cmd::new().arg("GET").arg("1231231231"))?;
        let rpy = RedisValue::new(rpy);

        println!("{}", rpy.is_string());
        println!("{}", rpy.get_string());

        Ok(())
    });
    join_handle.join().unwrap()
}

#[allow(unused)]
fn pointer_test() {
    let mut a = 0;
    let mut b = 0;

    unsafe {
        let mut pa: *mut i32 = &mut a;
        let mut pb: *mut i32 = &mut b;

        println!("{}({:?})", *pa, pa);
        println!("{}({:?})", *pb, pb);

        *pa = 123;
        *pb = 456;

        println!("{}({:?})", *pa, pa);
        println!("{}({:?})", *pb, pb);

        let temp_pa = pa;
        pa = pb;
        pb = temp_pa;

        println!("{}({:?})", *pa, pa);
        println!("{}({:?})", *pb, pb);
    }
}

#[allow(unused)]
fn test_thread_job_queue_st() {
    let mut thread_job_queue = ThreadJobQueue::<i32>::default();

    // publish
    {
        let mut a = 0;
        a += 1;
        thread_job_queue.push(a);
        a += 1;
        thread_job_queue.push(a);
        a += 1;
        thread_job_queue.push(a);
        a += 1;
        thread_job_queue.push(a);
        a += 1;
        thread_job_queue.push(a);
        a += 1;
        thread_job_queue.push(a);
    }

    // consume
    {
        thread_job_queue.consume_all(|element| {
            println!("{}", element);
        });
    }
}

#[allow(unused)]
pub(crate) fn test_thread_job_queue_mt() {
    let mut thread_job_queue: ThreadJobQueue<i32> = ThreadJobQueue::default();

    unsafe {
        let mut fn_get_clone = move || -> *mut ThreadJobQueue<i32> { &mut thread_job_queue };
        let clone_queue = fn_get_clone();

        // publish
        let join_handle = thread::spawn(move || -> () {
            let clone_queue = fn_get_clone();
            for line in std::io::stdin().lines() {
                let a = line.unwrap().parse::<i32>();
                if a.is_err() == true {
                    println!("exit publisher");
                    (*clone_queue).push(-1);
                    break;
                }
                let a = a.unwrap();
                (*clone_queue).push(a);
                println!("push({})", a);
            }
        });

        // consume
        {
            loop {
                let mut is_exit = false;
                (*clone_queue).consume_all(|elem| {
                    println!("pop({})", elem);
                    if elem == -1 {
                        is_exit = true;
                    }
                });

                if is_exit == true {
                    println!("exit subscriber");
                    break;
                }
            }
        }

        join_handle.join().unwrap();
    }
}
