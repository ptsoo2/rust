use std::io::ErrorKind::WouldBlock;
use std::net::{TcpListener, TcpStream};
use std::sync::atomic::AtomicBool;
use std::sync::atomic::Ordering::{Acquire, Release};
use std::sync::Arc;

use ex_common::{function, log};
use std::thread;
use std::thread::{sleep, spawn};
use std::time::Duration;

use chrono::{Duration, Local};

pub fn _test_closure_and_lambda() {
    let mut vec: Vec<i32> = Vec::new();
    vec.push(1);
    vec.push(1);

    log!("{:?}", vec.as_ptr());

    fn lambda_as_ref(vec: &Vec<i32>) {
        log!("{:?}", vec.as_ptr());
    }

    fn lambda_as_move(vec: Vec<i32>) {
        log!("{:?}", vec.as_ptr());
    }

    lambda_as_ref(&vec);
    // lambda_as_move(vec);

    let closure_as_ref = |vec: &Vec<i32>| {
        log!("{:?}", vec.as_ptr());
    };

    let _closure_as_move = |vec: Vec<i32>| {
        log!("{:?}", vec.as_ptr());
    };

    closure_as_ref(&vec);
    // closure_as_move(vec);

    let vec2: Vec<i32> = Vec::new();

    let closure_as_all_ref_capture = || {
        log!("{:?}", vec.as_ptr());
        log!("{:?}", vec2.as_ptr());
    };
    closure_as_all_ref_capture();

    let closure_as_all_move_capture = move || {
        log!("{:?}", vec.as_ptr());
        log!("{:?}", vec2.as_ptr());
    };
    closure_as_all_move_capture();
}

// attempt to add with overflow
pub fn _test_lambda_performance() {
    fn lambda() {
        let mut sum: u32 = 0;
        for idx in 0..10000000 {
            if u32::MAX - sum >= idx {
                sum = 0
            }
            sum += idx;
        }
    }

    lambda();
}

pub fn _test_closure_performance() {
    let closure = || {
        let mut sum: u32 = 0;
        for idx in 0..10000000 {
            if u32::MAX - sum >= idx {
                sum = 0
            }
            sum += idx;
        }
    };

    closure();
}

fn _handle_connection(stream: TcpStream) {
    log!("{:?}", stream);
}

pub fn _test_acceptor() {
    let stop_handle = Arc::new(AtomicBool::new(false));
    let stop_handle_clone = stop_handle.clone();

    ctrlc::set_handler(move || {
        log!("Signal detected!!!!!(request stop)");
        stop_handle_clone.store(true, Release);
    })
    .expect("Error setting Ctrl-C handler");

    let listener = TcpListener::bind("localhost:7878").unwrap();
    while listener.set_nonblocking(true).is_ok() == false {}

    log!("Waiting for Ctrl-C...");
    for stream in listener.incoming() {
        match stream {
            Ok(stream) => _handle_connection(stream),
            Err(err) => {
                if err.kind() != WouldBlock {
                    log!("leaving loop. error: {}", err);
                    break;
                }
            }
        }

        if stop_handle.load(Acquire) == true {
            log!("stop!!");
            break;
        }
    }

    log!("Exit!!!");
}

fn test_mq() {
    let conn_tune = ConnectionTuning::default();

    let mut conn = Connection::insecure_open_tuned("amqp://admin:admin@localhost:5672", conn_tune)?;
    let channel = conn.open_channel(Some(1))?;

    let exchange = channel.exchange_declare(
        ExchangeType::Direct,
        "rust.direct",
        ExchangeDeclareOptions {
            durable: false,
            auto_delete: false,
            internal: false,
            arguments: FieldTable::new(),
        },
    )?;

    loop {
        bench_multiple("test", 1000, || {
            exchange.publish(Publish::new(b"hel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel1239072309712309712hel12390hel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there7230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there39071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel1239072309712309712hel12390hel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there7230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there39071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo therehel123907230971230971239071290319027390127097lo there", "hello"));
        });
        sleep(Duration::from_millis(10));
    }
}

fn test_redis() {
    let connection_info = redis_entry::make_connection_info("localhost", 6379, 1, None, None);

    let pool_config = redis_entry::StubConfig::default();
    let pool = redis_entry::make_pool_default(connection_info, pool_config, None)?;

    let mut conn = pool.get()?;
    {
        let rpy = conn.req_command(Cmd::new().arg("PING"))?;
        if let Value::Status(stat) = rpy {
            println!("{}", stat);
        }
    }
    {
        let a = 1;
    }
    {
        // 와.. 너무 쓰레기같이 써야하네..
        let result: Vec<Value> = Pipeline::with_capacity(3)
            .set("132123", "!@3123")
            .get("132123")
            .zrevrange("test_ranking", 0, -1)
            .query(&mut conn)?;

        let result = result.get(3).unwrap();
        if let Value::Bulk(result) = result {
            println!("{:?}", result);
        }
    }
}
